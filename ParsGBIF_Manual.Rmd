---
title: "ParsGBIF Manual"

author:
  - Pablo Hendrigo Alves de Melo^[Instituto Federal de Educação, Ciência e Tecnologia de Minas Gerais, pablopains@yahoo.com.br]
  - Nadia Bystriakova^[Natural History Museum, London, n_bystriakova@yahoo.com]
  - Alexandre Monro^[Royal Botanic Gardens, Kew, a.monro@kew.org]
  
date: "`r Sys.Date()`"
  
output: word_document

template: template.tex
---

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
```

# ParsGBIF Manual


ParsGBIF package is designed to convert [Global Biodiversity Information Facility - GBIF](https://www.gbif.org/) species occurrence data to a more comprehensible format to be used for further analysis, e.g. spatial. The package provides tools for verifying and standardizing species scientific names and for selecting the most informative species records when duplicates are available. The Manual provides a brief introduction to ParsGBIF, with more information available from Help pages accessed via help(function_name).

## Installation

You can install the development version of ParsGBIF from [GitHub](https://github.com/pablopains/ParsGBIF).
To install ParsGBIF, run 

``` r
devtools::install_github("pablopains/ParsGBIF")
```

Please site ParsGBIF as:
```{r}
print(citation("ParsGBIF"), bibtex = FALSE)
```

## Example
__ParsGBIF makes it easy to get species occurrence records based on GBIF.__

### 1. GBIF data preparation
#### 1.1. Obtaining occurrence data of the herbarium specimen from GBIF
  1.1.1. Access a registered account in [GBIF](gbif.org) 
  
  1.1.2. Filter occurrences with the following parameters:
  
  * Basis of record: _Preserved specimen_
  * Occurrence status: _present_
  * Scientific name: _Botanical family name_ or __filter by other fields__

  1.1.3. Request to download information in __DARWIN CORE ARCHIVE FORMAT__
  
  1.1.4. Download compressed file and unzip downloaded file
  
  1.1.5. Use the __occurrence.txt__ file as input to the prepare_gbif_occurrence_data(gbif_occurrece_file = 'occurrence.txt') function
  
#### 1.2. Preparing occurrence data downloaded from GBIF 

To prepare occurrence data downloaded from GBIF to be used by ParsGBIF functions, run prepere_gbif_occurrence_data.

```{r example_prepare_gbif_occurrence_data, eval=TRUE, message=FALSE, warning=FALSE}
  occ_file <- 'https://raw.githubusercontent.com/pablopains/ParsGBIF/main/dataGBIF/Achatocarpaceae/occurrence.txt'

  occ <- ParsGBIF::prepare_gbif_occurrence_data(gbif_occurrece_file = occ_file, columns = 'standard')

  head(occ)
```

When parsing data, the user can choose between “standard” and “all” columns to be selected. The “standard” format has 54 data fields (columns), and the “all” format, 257 data fields (columns).

```{r example_select_gbif_fields, eval=TRUE, message=FALSE, warning=FALSE}
  col_standard <- ParsGBIF::select_gbif_fields(columns = 'standard')
  
  str(col_standard)

  col_all <- ParsGBIF::select_gbif_fields(columns = 'all')

  str(col_all)
```


#### 1.3. Extracting GBIF issue 
```{r aaa, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
data(EnumOccurrenceIssue)
colnames(EnumOccurrenceIssue)

help(EnumOccurrenceIssue)
print(?ParsGBIF::EnumOccurrenceIssue)
```


```{r example_extract_gbif_issue, eval=TRUE, message=FALSE, warning=FALSE}
  occ_file <- 'https://raw.githubusercontent.com/pablopains/ParsGBIF/main/dataGBIF/Achatocarpaceae/occurrence.txt'

  occ <- ParsGBIF::prepare_gbif_occurrence_data(gbif_occurrece_file = occ_file,
                                     columns = 'standard')
  
  
 occ_gbif_issue <- ParsGBIF::extract_gbif_issue(occ = occ)

 names(occ_gbif_issue)

 head(occ_gbif_issue$summary)

```

### 2. Check species names against WCVP database

The World Checklist of Vascular Plants (WCVP) database is available from the (Royal Botanic Gardens, Kew) [https://powo.science.kew.org/about-wcvp]. It can be downloaded to a folder of the user’s choice or into memory using get_wcvp function. The output has 33 columns.

```{r example_wcvp_names, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
data(wcvp_names_Achatocarpaceae)
wcvp_names <- wcvp_names_Achatocarpaceae

# wcvp_names <- get_wcvp(read_only_to_memory = TRUE)$wcvp_names

colnames(wcvp_names)
```

Species’ names can be checked against WCVP database one by one or in a batch mode. To verify individual names, the function checkName_wcvp is used.

```{r example_checkName_wcvp, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
data(wcvp_names_Achatocarpaceae)
wcvp_names <- wcvp_names_Achatocarpaceae

# wcvp_names <- get_wcvp(read_only_to_memory = TRUE)$wcvp_names

name.checked <- checkName_wcvp(searchedName = 'Achatocarpus mollis H.Walter',
               wcvp_names = wcvp_names,
               if_author_fails_try_without_combinations = TRUE)
name.checked[,c(3:5,22,23,40)]
```

To check names in a batch mode, there is batch_checkName_wcvp function. It uses the occurrence data (occ) and WCVP names list (wcvp_names) generated in the previous steps.

```{r example_batch_checkName_wcvp, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
data(wcvp_names_Achatocarpaceae)
wcvp_names <- wcvp_names_Achatocarpaceae

# wcvp_names <- get_wcvp(read_only_to_memory = TRUE)$wcvp_names

occ_file <- 'https://raw.githubusercontent.com/pablopains/ParsGBIF/main/dataGBIF/Achatocarpaceae/occurrence.txt'

occ <- prepare_gbif_occurrence_data(gbif_occurrece_file = occ_file,
                                    columns = 'standard')

names.checked <- batch_checkName_wcvp(occ = occ,
                                                 wcvp_names =  wcvp_names,
                                                 if_author_fails_try_without_combinations = TRUE,
                                                 wcvp_selected_fields = 'standard')

names(names.checked)

head(names.checked$summary)

```

To bring species’ names into line with the format used by WCVP, the function standardize_scientificName inserts space between the hybrid separator (x) and specific epithet, and also standardizes abbreviations of infrataxa (variety, subspecies, form).

```{r example_standardize_scientificName, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)

# hybrid separator
standardize_scientificName('Leucanthemum ×superbum (Bergmans ex J.W.Ingram) D.H.Kent')

# variety 
standardize_scientificName('Platymiscium pubescens subsp. fragrans (Rusby) Klitg.')

# subspecies

```

The funtion get_lastNameRecordedB returns the last name of the main collector in recordedBy field.

```{r example_get_lastNameRecordedBy, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
get_lastNameRecordedBy('Melo, P.H.A, Bystriakova, N. & Monro, A.')

get_lastNameRecordedBy('Monro, A.; Bystriakova, N. & Melo, P.H.A')

get_lastNameRecordedBy('Bystriakova, N., Monro, A.,Melo, P.H.A')

```


### 3. Collectors Dictionary

To extract the last name of the main collector based on the recordedBy field and assemble a list relating the last name of the main collector and the raw data from the recordedBy, use the prepare_collectorsDictionary function. It uses the occurrence data (occ) generated in the previous step.

It is recommended to curate the main collector's surname automatically extracted from the recordedBy field. The aim is to standardize the main collector's last name, so that a botanical collector is always recognized by the same last name, standardized in capital letters and with non-ascii characters replaced.

Once cured, the collector's dictionary can be reused in the future. If the searched recordedBy exists in the collector's dictionary, the function returns the last name of the main collector referring to recordedBy (In this case the collectorDictionary field will be indicated with 'checked'), otherwise, it returns the last name of the main collector, extracted from the recordedBy field.

```{r example_prepare_collectorsDictionary, eval=TRUE, message=FALSE, warning=FALSE}
library(ParsGBIF)
data(wcvp_names_Achatocarpaceae)
wcvp_names <- wcvp_names_Achatocarpaceae

# wcvp_names <- get_wcvp(read_only_to_memory = TRUE)$wcvp_names

occ_file <- 'https://raw.githubusercontent.com/pablopains/ParsGBIF/main/dataGBIF/Achatocarpaceae/occurrence.txt'

occ <- prepare_gbif_occurrence_data(gbif_occurrece_file = occ_file,
                                    columns = 'standard')

collectorsDictionary.dataset <- prepare_collectorsDictionary(occ = occ)

names(names.checked)

head(names.checked$summary)

```

